<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Clipper</title>
    <meta name="description" content="Extract the best moments from any YouTube video.">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="layout-container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">AI Video Clipper</h1>
            <button id="themeToggle" class="theme-toggle" aria-label="Toggle Dark Mode">
                <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg class="icon-moon hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </header>

        <!-- Main Input Section -->
        <main class="main-content">
            <form id="clipForm" class="clip-form" onsubmit="processVideo(event)">
                <div class="input-group">
                    <input type="url" id="youtubeUrl" class="input-url" placeholder="Paste YouTube URL here..." required autocomplete="off">
                </div>

                <div class="controls-grid">
                    <div class="control-item">
                        <label for="durationMode">Clip Duration</label>
                        <div class="select-wrapper">
                            <select id="durationMode">
                                <option value="short">Short (30-60s)</option>
                                <option value="long">Long (90-120s)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="control-item">
                        <label for="numClips">Number of Clips</label>
                        <div class="select-wrapper">
                            <select id="numClips">
                                <option value="1">1</option>
                                <option value="3" selected>3</option>
                                <option value="5">5</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Optional Keyword (Hidden by default or minimalist) -->
                <div class="control-item" style="margin-top: 1rem;">
                    <label for="keyword" class="sr-only">Topic (Optional)</label>
                    <input type="text" id="keyword" class="input-keyword" placeholder="Filter by topic (optional)...">
                </div>

                <div class="action-area">
                    <button type="submit" id="processBtn" class="btn-primary">Generate Clips</button>
                </div>
            </form>

            <!-- Status / Loading -->
            <div id="statusArea" class="status-area hidden">
                <div class="loading-spinner"></div>
                <p id="statusMessage" class="status-message">Analyzing video...</p>
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
            </div>

            <!-- Error -->
            <div id="errorArea" class="error-area hidden">
                <p id="errorMessage"></p>
                <button type="button" onclick="hideError()" class="btn-text">Dismiss</button>
            </div>

            <!-- Results -->
            <div id="resultsArea" class="results-area hidden">
                <div class="results-header">
                    <h2>Results</h2>
                    <button onclick="downloadAll()" class="btn-secondary btn-sm">Download All ZIP</button>
                </div>
                <div id="clipsList" class="clips-list">
                    <!-- Clips injected here -->
                </div>
            </div>
        </main>
        
        <footer class="app-footer">
            <p>Powered by AI Video Clipper</p>
        </footer>
    </div>

    <script src="/static/script.js"></script>
    <script>
        // Inline script for simplicity or move to static/script.js
        // Theme Toggle Logic
        const themeToggle = document.getElementById('themeToggle');
        const iconSun = document.querySelector('.icon-sun');
        const iconMoon = document.querySelector('.icon-moon');
        
        // Check system preference using matchMedia
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                iconSun.classList.add('hidden');
                iconMoon.classList.remove('hidden');
            } else {
                iconSun.classList.remove('hidden');
                iconMoon.classList.add('hidden');
            }
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            setTheme(savedTheme);
        } else {
            setTheme(prefersDark.matches ? 'dark' : 'light');
        }

        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            setTheme(current === 'dark' ? 'light' : 'dark');
        });

        // App Logic
        let currentYoutubeId = null;

        function showStatus(msg) {
            const area = document.getElementById('statusArea');
            area.classList.remove('hidden');
            document.getElementById('statusMessage').textContent = msg;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('errorArea').classList.add('hidden');
        }

        function hideStatus() {
            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('processBtn').disabled = false;
        }

        function showError(msg) {
            hideStatus();
            const area = document.getElementById('errorArea');
            area.classList.remove('hidden');
            document.getElementById('errorMessage').textContent = msg;
        }

        function hideError() {
            document.getElementById('errorArea').classList.add('hidden');
        }

        async function processVideo(e) {
            e.preventDefault();
            const url = document.getElementById('youtubeUrl').value;
            const durationMode = document.getElementById('durationMode').value;
            const numClips = document.getElementById('numClips').value;
            const keyword = document.getElementById('keyword').value;

            showStatus("Downloading & Analyzing video... this may take a minute.");

            try {
                const res = await fetch('/process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url, duration_mode: durationMode, num_clips: numClips, keyword })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Failed to process');
                
                hideStatus();
                displayResults(data);
            } catch (err) {
                showError(err.message);
            }
        }

        function displayResults(data) {
            currentYoutubeId = data.youtube_id;
            const list = document.getElementById('clipsList');
            list.innerHTML = '';
            document.getElementById('resultsArea').classList.remove('hidden');

            data.clips.forEach((clip, i) => {
                const div = document.createElement('div');
                div.className = 'clip-item';
                div.innerHTML = `
                    <div class="clip-preview">
                        <video controls preload="metadata" src="/clips/${data.youtube_id}/${clip.filename}"></video>
                    </div>
                    <div class="clip-details">
                        <h3>${clip.title || `Clip ${i+1}`}</h3>
                        <p class="clip-desc">${clip.description || ''}</p>
                        <div class="clip-meta">
                            <span>${clip.duration.toFixed(1)}s</span>
                            <a href="/clips/${data.youtube_id}/${clip.filename}" download class="btn-download">Download MP4</a>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Smooth scroll
            list.scrollIntoView({behavior: 'smooth', block: 'start'});
        }

        function downloadAll() {
            if(currentYoutubeId) window.location.href = `/download_all/${currentYoutubeId}`;
        }
    </script>
</body>
</html>